<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Trends</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Minimal styles; Tailwind build to be added later -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 1rem; }
    .container { max-width: 960px; margin: 0 auto; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .controls { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: .5rem; }
    label { display: flex; flex-direction: column; font-size: .875rem; }
    input, select, button { padding: .5rem; font-size: 1rem; }
    .charts { margin-top: 1rem; display: grid; gap: 1rem; }
    canvas { width: 100%; height: 280px; }
  </style>
  <script src="https://unpkg.com/htmx.org@2.0.6" integrity="sha384-ksKjJrwjL5VxqAkAZAVOPXvMkwAykMaNYegdixAESVr+KqLkKE8XBDoZuwyWVUDv" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Trends</h1>
      <button id="loadBtn" type="button">Load</button>
    </header>

    <section class="controls">
      <label>From
        <input id="from" type="date">
      </label>
      <label>To
        <input id="to" type="date">
      </label>
      <label>Bucket
        <select id="bucket">
          <option value="day" selected>day</option>
          <option value="week">week</option>
        </select>
      </label>
    </section>

    <section class="charts">
      <div>
        <h2>Sleep Bars</h2>
        <canvas id="bars"></canvas>
      </div>
      <div>
        <h2>Duration (avg)</h2>
        <canvas id="duration"></canvas>
      </div>
      <div>
        <h2>Quality (avg)</h2>
        <canvas id="quality"></canvas>
      </div>
      <div>
        <h2>Latency (median)</h2>
        <canvas id="latency"></canvas>
      </div>
    </section>
  </div>

  <script type="module">
    const $ = (sel) => document.querySelector(sel);

    function defaultRange() {
      const to = new Date();
      const from = new Date(to.getTime() - 29 * 24 * 3600 * 1000);
      const fmt = (d) => d.toISOString().slice(0, 10);
      return { from: fmt(from), to: fmt(to) };
    }

    function ensureDefaults() {
      const r = defaultRange();
      if (!$('#from').value) $('#from').value = r.from;
      if (!$('#to').value) $('#to').value = r.to;
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    let charts = {};

    function upsertChart(id, cfg) {
      const ctx = document.getElementById(id).getContext('2d');
      if (charts[id]) {
        charts[id].destroy();
      }
      charts[id] = new Chart(ctx, cfg);
    }

    async function loadBars() {
      const from = $('#from').value;
      const to = $('#to').value;
      const data = await fetchJSON(`/api/trends/sleep-bars?from=${from}&to=${to}`);
      const labels = data.map(d => d.date);
      const durations = data.map(d => d.duration_min != null ? d.duration_min / 60.0 : null);
      upsertChart('bars', {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Duration (h)',
            data: durations,
            backgroundColor: 'rgba(59, 130, 246, 0.5)',
          }]
        },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
      });
    }

    async function loadSummary() {
      const from = $('#from').value;
      const to = $('#to').value;
      const bucket = $('#bucket').value;
      const s = await fetchJSON(`/api/trends/summary?from=${from}&to=${to}&bucket=${bucket}`);

      const dur = s.duration_by_bucket;
      upsertChart('duration', {
        type: 'line',
        data: {
          labels: dur.map(d => d.bucket),
          datasets: [{
            label: 'avg hours',
            data: dur.map(d => d.avg_min / 60.0),
            borderColor: 'rgb(34,197,94)',
          }]
        }
      });

      const q = s.quality_by_bucket;
      upsertChart('quality', {
        type: 'line',
        data: {
          labels: q.map(d => d.bucket),
          datasets: [{
            label: 'quality avg',
            data: q.map(d => d.avg),
            borderColor: 'rgb(234,179,8)',
          }]
        },
        options: { scales: { y: { suggestedMin: 1, suggestedMax: 5 } } }
      });

      const l = s.latency_by_bucket;
      upsertChart('latency', {
        type: 'line',
        data: {
          labels: l.map(d => d.bucket),
          datasets: [{
            label: 'median latency (min)',
            data: l.map(d => d.median),
            borderColor: 'rgb(239,68,68)',
          }]
        }
      });
    }

    async function loadAll() {
      ensureDefaults();
      await loadBars();
      await loadSummary();
    }

    $('#loadBtn').addEventListener('click', loadAll);
    ensureDefaults();
  </script>
</body>
</html>
